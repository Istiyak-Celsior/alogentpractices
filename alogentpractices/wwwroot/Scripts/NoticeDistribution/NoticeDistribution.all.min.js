var ApiService=function(n){function i(i,u){return n.ajax({url:r(u.area,u.controller,u.action),method:i,cache:!1,contentType:"application/json",data:u.data!=undefined?JSON.stringify(u.data):undefined,beforeSend:function(n){typeof u.username!="undefined"&&n.setRequestHeader("x-accuaccount-username",u.username);typeof u.password!="undefined"&&n.setRequestHeader("x-accuaccount-password",u.password);t.requestStart&&t.requestStart.bind(t)()},complete:function(){t.requestEnd&&t.requestEnd.bind(t)()},success:function(n){typeof u.success!="undefined"&&u.success(n);typeof t.success!="undefined"&&t.success()},error:function(n){var i={statusCode:n.status,statusDescription:n.statusText,errorMessage:n.responseJSON!=null?n.responseJSON.ErrorMessage:"A general failure occurred communicating with the server (status: "+n.statusText+").",response:n};typeof u.error!="undefined"&&u.error(i);typeof t.error!="undefined"&&t.error(i)}})}function r(n,t,i){var r="";return n===null?r+="api/":n===""||(r+="api/"),r+=t,i&&(r+="/",r+=i),r}var t={authorizationHeader:undefined,error:undefined,get:undefined,post:undefined,success:undefined,requestStart:undefined,requestEnd:undefined};return t.delete=function(n){return i("DELETE",n)},t.get=function(n){return i("GET",n)},t.patch=function(n){return i("PATCH",n)},t.post=function(n){return i("POST",n)},t.put=function(n){return i("PUT",n)},t};(function(n,t,i){i.mvvm||(i.mvvm={});i.mvvm.Model=i.data.Model.extend({init:function(){i.data.Model.fn.init.call(this)}});i.mvvm.View=i.Class.extend({init:function(n,i){var r=this;r.viewModel=i;t(document).ready(t.proxy(r._ready,r,t(n),i))},_ready:function(n,r){t("[data-role='pageload']").remove();i.ui.progress(n,!0);this.ready(n,r)},ready:function(n,t){i.bind(n,t);i.ui.progress(n,!1)}});i.mvvm.ViewModel=i.data.ObservableObject.extend({init:function(){i.data.ObservableObject.fn.init.call(this,this)}});i.mvvm.DialogViewModel=i.mvvm.ViewModel.extend({init:function(){ViewModel.fn.init.call(this)},triggerClose:function(n,t){this.trigger("close",{userTriggered:n,dialogResult:t})}});i.mvvm.DialogService=i.Class.extend({init:function(n){this.views=n},hasDialogOpen:!1,views:{},open:function(n,r){var o,c;if(!n)throw"Required [view] is missing.";var e=new t.Deferred,s=t("<div class='k-custom-dialog' />").kendoDialog({actions:r.actions,close:function(){this.destroy()}}),f=this.views[n],l=f.id,a=t(l).html(),u=s.data("kendoDialog"),h=t(i.template(a)(r.viewModel));if(u.content(h),f.cssClass){let n=u.element.closest(".k-dialog");t(n).addClass(f.cssClass)}if(f.cssContentClass){let n=s;t(n).addClass(f.cssContentClass)}return u.bind("close",function(n){e.state()!=="resolved"&&e.resolve({userTriggered:n.userTriggered,dialogResult:null})}),r.viewModel&&(i.bind(h,r.viewModel),r.viewModel instanceof i.mvvm.DialogViewModel&&r.viewModel.bind("close",function(n){e.resolve({userTriggered:n.userTriggered,dialogResult:n.dialogResult});u.close()})),r.title&&u.title(r.title),u.open(),this.hasDialogOpen=!0,r.opened&&t.proxy(r.opened(),this),o=e.promise(),c=this,o.always(function(){c.hasDialogOpen=!1}),o}});n.Model=i.mvvm.Model;n.ViewModel=i.mvvm.ViewModel;n.View=i.mvvm.View})(window,window.kendo.jQuery,window.kendo);let KendoGridHelper=undefined;(function(){KendoGridHelper=kendo.Class.extend({init:function(){},multiCheckFilter:{sort:function(n,t,i){let f=n.thead.find("[data-field="+t+"]"),r=f.data("kendoFilterMultiCheck"),u=r.checkSource;r.container.empty();u.sort({field:t,dir:i});u.data(u.view().toJSON());r.createCheckBoxes()}}})})();var NoticeDistributionClient=function(){return kendo.Class.extend({init:function(n){this.api=n},api:undefined,getDeliveredNotices:function(n){return this.api.get({area:"",controller:"notice/distribution",action:`directory/delivered?noticeId=${n}`})},getPackage:function(){return this.api.get({area:"",controller:"notice/distribution",action:"package"})},postDistributionPackage:function(n){return this.api.post({area:"",controller:"notice/distribution",action:"package",data:n})},postEnvelopeEmailAlertBatch:function(n){let t=[];for(let n of n)t.push({method:"POST",url:`notice/distribution/envelope/${n}/alerts/email`});return this.api.post({area:"",controller:"notice/distribution",action:`envelope/$batch`,data:t})},postDeleteEnvelopeBatch:function(n){let t=[];for(let n of n)t.push({method:"DELETE",headers:[{"Content-Type":"application/json"}],url:`notice/distribution/envelope/${n}`});return this.api.post({area:"",controller:"notice/distribution",action:`envelope/$batch`,data:t})},postDeliveredEnvelopeBatch:function(n){let t=[];for(let n of n)t.push({method:"POST",headers:[{"Content-Type":"application/json"}],url:`notice/distribution/package/${n}/delivered`});return this.api.post({area:"",controller:"notice/distribution",action:`envelope/$batch`,data:t})},maps:{mapExceptionPolicy:function(n){return{id:n.Id,name:n.Name,documentType:n.DocumentType,accountType:n.AccountType,type:n.Type,accountClass:n.Class}}}})}(),Notice=function(n,t){return t.data.ObservableObject.extend({init:function(n){t.data.ObservableObject.fn.init.call(this,n);this.set("exceptionDate",new Date(n.exceptionDate))}})}(window.kendo.jQuery,window.kendo),NoticeEnvelope=function(n,t){return t.data.ObservableObject.extend({init:function(n){t.data.ObservableObject.fn.init.call(this,n);this.set("contactByMailYN",n.contactByMail==!0?"Y":"N");this.set("lastEmailAlert",this._getLastEmailAlert());this.set("lastEmailAlertDeliveryState",this._getLastEmailAlertDeliveryState());n.deliveryDate&&this.set("deliveryDate",new Date(n.deliveryDate))},_getLastEmailAlert:function(){let n=this.get("alerts");if(n.length==0)return{deliveryState:"",deliveryStatus:""};return n[0]},_getLastEmailAlertDeliveryState:function(){let n=this._getLastEmailAlert();return n==null?"":n.deliveryState}})}(window.kendo.jQuery,window.kendo),PendingNotices=function(n,t){return t.data.ObservableObject.extend({init:function(n){t.data.ObservableObject.fn.init.call(this,n);n.contactName==null&&this.set("contactName","");n.contactEmail==null&&this.set("contactEmail","");n.contactAddress==null&&this.set("contactAddress","")}})}(window.kendo.jQuery,window.kendo),NoticeDistributionPackage=function(n,t){return t.data.ObservableObject.extend({init:function(){t.data.ObservableObject.fn.init.call(this,this)},deliverable:[],undeliverable:[],inProcess:[],addDeliverable:function(n){this.deliverable.empty();this.deliverable.push.apply(this.deliverable,n)},addInProcess:function(n){this.inProcess.empty();this.inProcess.push.apply(this.inProcess,n)},addUndeliverable:function(n){this.undeliverable.empty();let t=this.groupUndeliverableNotices(n);this.undeliverable.push.apply(this.undeliverable,t)},_getDeliverByValue:function(n){return n.holdLetter?"Do Not Contact":n.usePaper&&!n.useEmail?"Paper":n.useEmail&&!n.usePaper?"Email":n.holdLetter||n.useEmail||n.usePaper?"Any":"Unspecified"},groupUndeliverableNotices:function(n){return n.reduce((n,t)=>{const i=n.find(n=>n.recordNumber==t.recordNumber);return i?i.items.push(t):n.push({recordLink:t.recordLink,recordName:t.recordName,recordNumber:t.recordNumber,usePaper:t.usePaper,useEmail:t.useEmail,hasValidAddress:t.hasValidAddress,hasValidEmail:t.hasValidEmail,contactName:t.contactName,contactAddress:t.contactAddress==null?"":t.contactAddress,contactEmail:t.contactEmail==null?"":t.contactEmail,contactMethod:t.contactMethod,holdLetter:t.holdLetter,deliverBy:this._getDeliverByValue(t),items:[t]}),n},[])}})}(window.kendo.jQuery,window.kendo),UnsentNoticesViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i,r){ViewModel.fn.init.call(this);this._noticeClient=n;this._dialogService=t;this._gridHelper=i;this.set("distributionPackage",r);this.set("notices",this._notices(this,n,r))},confirmDistribute:function(){let n=t.confirm("Letters for the selected notices will be generated, mail merged, packaged, and moved into the distribution queue where you can distribute them to contacts. Any electronic alerts contacts have opted into will also be automatically queued and sent.");n.done(()=>this.distributeSelected(this.selection))},distributionPackage:null,hasSelection:!1,selection:[],count:function(){let n=this.get("notices"),t=n.data();return t.length},deselect:function(){this.selection.empty();this.set("hasSelection",!1)},distributeSelected:function(n){let t=n.map(n=>n.letterId),i=this._noticeClient.postDistributionPackage({noticeIdentities:t});i.then(n=>{let t=n.filter(n=>n.contactByEmail===!0).map(n=>n.id),i;i=t.length===0?Promise.resolve([]):this._noticeClient.postEnvelopeEmailAlertBatch(t);i.then(n=>{let t=n.filter(n=>n.statusCode<200||n.statusCode>=300),i=this._refreshPackage();i.then(()=>{t.length>0&&this._displayBatchError(t)})})})},onFilterInit:function(n){this._gridHelper.multiCheckFilter.sort(n.sender,n.field,"asc")},onSelect:function(n){let i=n.sender,r=i.selectedKeyNames(),t=r.map(n=>this.notices.data().find(t=>t.letterId==n));this.set("hasSelection",t.length>0);this.selection.empty();for(let n of t)this.selection.push(n)},openHistory:function(n){let t=n.data,i=t.letterId,r=this._noticeClient.getDeliveredNotices(i);r.then(n=>{var i=n.map(n=>new NoticeEnvelope(n));this._dialogService.open("historyDialog",{title:`Completed Stages for ${t.exception}`,viewModel:{notices:i,printOne:this.printOne.bind(this),_mapPrintLetters:this._mapPrintLetters.bind(this)},actions:[{text:"OK"}]})})},printOne:function(n){let t=n.data;this.trigger("print",{items:this._mapPrintLetters([t])})},_displayBatchError:function(n){this._dialogService.open("apiErrorDialog",{title:"Oops!",viewModel:{Status:"204",ErrorMessage:`${n.length} items could not be processed.`,Reason:"",Errors:n.map(n=>n.body)},actions:[{text:"OK"}]})},_mapPrintLetters:function(n){return n.map(n=>({name:n.name,contactAddress:n.contactAddress,contactEmail:n.contactEmail,letterHeader:n.letterHeader,letterBody:n.letterBody,letterFooter:n.letterFooter}))},_notices:function(n,i,r){return new t.data.DataSource({data:r.deliverable,pageSize:20,schema:{model:{id:"letterId"}},sort:[{field:"exceptionDate",dir:"asc"},{field:"recordName"},{field:"recordNumber"},{field:"exception"}]})},_refreshPackage:function(){let n=this._noticeClient.getPackage();return n.then(n=>{let t=n.deliverable.map(n=>new Notice(n)),i=n.undeliverable.map(n=>new PendingNotices(n)),r=n.inProcess.map(n=>new NoticeEnvelope(n));return this.distributionPackage.addDeliverable(t),this.distributionPackage.addUndeliverable(i),this.distributionPackage.addInProcess(r),this.deselect(),n})}})}(window.kendo.jQuery,window.kendo),InProcessNoticesViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i,r){ViewModel.fn.init.call(this);this._noticeClient=n;this._dialogService=t;this._gridHelper=i;this.set("distributionPackage",r);this.set("notices",this._notices(r))},cancel:function(n){let t=n.map(n=>n.id),i=this._noticeClient.postDeleteEnvelopeBatch(t);i.then(n=>{let t=n.filter(n=>n.statusCode<200||n.statusCode>=300),i=this._refreshPackage();i.then(()=>{t.length>0&&this._displayBatchError(t)})})},confirmCancel:function(){let n=t.confirm("The selected notices will be removed from distribution and restored as active notices. This does not cancel any electronic alerts or mail that was already sent.");n.done(()=>this.cancel(this.selection))},confirmMarkDelivered:function(){let n=t.confirm("The selected notices will be have  their delivery date set and will be permanently archived. Staged notices will be allowed to move into their next stage after the appropriate time period has elapsed. This cannot be undone.");n.done(()=>this.markDelivered(this.selection))},count:function(){let n=this.get("notices"),t=n.view();return t.length},deselect:function(){this.selection.empty();this.set("hasSelection",!1)},distributionPackage:null,hasSelection:!1,markDelivered:function(n){let t=n.map(n=>n.id),i=this._noticeClient.postDeliveredEnvelopeBatch(t);i.then(n=>{let t=n.filter(n=>n.statusCode<200||n.statusCode>=300),i=this._refreshPackage();i.then(()=>{t.length>0&&this._displayBatchError(t)})})},selection:[],onFilterInit:function(n){this._gridHelper.multiCheckFilter.sort(n.sender,n.field,"asc")},onSelect:function(n){let i=n.sender,r=i.selectedKeyNames(),t=r.map(n=>this.notices.data().find(t=>t.id==n));this.set("hasSelection",t.length>0);this.selection.empty();for(let n of t)this.selection.push(n)},print:function(){this.trigger("print",{items:this._mapPrintLetters(this.selection)})},printOne:function(n){let t=n.data;this.trigger("print",{items:this._mapPrintLetters([t])})},_displayBatchError:function(n){this._dialogService.open("apiErrorDialog",{title:"Oops!",viewModel:{Status:"204",ErrorMessage:`${n.length} items could not be processed.`,Reason:"",Errors:n.map(n=>n.body)},actions:[{text:"OK"}]})},_mapPrintLetters:function(n){return n.map(n=>({name:n.name,contactAddress:n.contactAddress,contactEmail:n.contactEmail,letterHeader:n.letterHeader,letterBody:n.letterBody,letterFooter:n.letterFooter}))},_notices:function(n){return new t.data.DataSource({data:n.inProcess,schema:{model:{id:"id"}}})},_refreshPackage:function(){let n=this._noticeClient.getPackage();return n.then(n=>{let t=n.deliverable.map(n=>new Notice(n)),i=n.undeliverable.map(n=>new PendingNotices(n)),r=n.inProcess.map(n=>new NoticeEnvelope(n));return this.distributionPackage.addDeliverable(t),this.distributionPackage.addUndeliverable(i),this.distributionPackage.addInProcess(r),this.deselect(),n})}})}(window.kendo.jQuery,window.kendo),PendingNoticesViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i,r){ViewModel.fn.init.call(this);this._dialogService=t;this._gridHelper=i;this.set("notices",this._notices(r))},count:function(){let n=this.get("notices"),t=n.view();return t.reduce((n,t)=>n+t.items.length,0)},onFilterInit:function(n){this._gridHelper.multiCheckFilter.sort(n.sender,n.field,"asc")},_notices:function(n){let i=this;return new t.data.DataSource({data:n.undeliverable,sort:[{field:"recordName",dir:"asc"},{field:"recordNumber",dir:"asc"}]})}})}(window.kendo.jQuery,window.kendo),SentNoticesViewModel=function(n,t){return ViewModel.extend({init:function(n,t){ViewModel.fn.init.call(this);this._dialogService=t;this.set("notices",this._notices(this,n))},_notices:function(){return new t.data.DataSource({transport:{read:function(){}},sort:[{field:"RecordName"},{field:"RecordNumber"},{field:"RecordType"}]})}})}(window.kendo.jQuery,window.kendo),PrintViewModel=function(){return ViewModel.extend({letters:[]})}(window.kendo.jQuery,window.kendo),NoticeDistributionViewModel=function(){return ViewModel.extend({init:function(n,t,i){ViewModel.fn.init.call(this);let r=new NoticeDistributionClient(n);this.initDistribution=function(){let n=r.getPackage();return n.done(n=>{var u=new NoticeDistributionPackage,f=n.deliverable.map(n=>new Notice(n)),e=n.undeliverable.map(n=>new PendingNotices(n)),o=n.inProcess.map(n=>new NoticeEnvelope(n));this.set("unsentNotices",new UnsentNoticesViewModel(r,t,i,u));this.set("pendingNotices",new PendingNoticesViewModel(r,t,i,u));this.set("inProcessNotices",new InProcessNoticesViewModel(r,t,i,u));this.set("sentNotices",new SentNoticesViewModel(r,t,u));u.addDeliverable(f);u.addUndeliverable(e);u.addInProcess(o)}),n}}})}(window.kendo.jQuery,window.kendo),NoticeDistributionView=function(n,t,i){return View.extend({init:function(i,r,u,f){View.fn.init.call(this,i,r);this._webapi=u;this._webapi.error=this.onApiError.bind(this);this._webapi.requestStart=()=>t.ui.progress(n(document.body),!0);this._webapi.requestEnd=()=>t.ui.progress(n(document.body),!1);this._dialogService=f},ready:function(i,r){var u=this,f;View.fn.ready.call(u,i,r);t.ui.progress(n(document.body),!0);f=r.initDistribution();f.then(()=>{t.ui.progress(n(document.body),!1),n(".init-hidden").removeClass("init-hidden"),u._ui(i,r),u._events(r),u._nav(r)})},onApiError:function(n){let t=n.response.responseJSON;(t==null||t==i)&&(t={ErrorMessage:n.response.responseText,Errors:[]});t.Status=n.response.status;t.Reason=n.response.statusText;this._dialogService.open("apiErrorDialog",{title:"Oops!",viewModel:t,actions:[{text:"OK"}]})},onfocus:function(){let n;setTimeout(function(){n.focus();n.scrollIntoView({behavior:"smooth"})})},ui:{letterGrid:i},_events:function(n){n.inProcessNotices.bind("print",this._print);n.unsentNotices.bind("print",this._print)},_nav:function(){const n=new URLSearchParams(window.location.search)},_print:function(i){let r=document.getElementById("printframe");t.ui.progress(n(document.body),!0);let e=r.contentDocument||r.contentWindow.document,u=n(e).find("body"),f=new PrintViewModel;t.unbind(u);f.set("letters",i.items);t.bind(u,f);t.ui.progress(n(document.body),!1);r.focus();r.contentWindow.print()},_ui:function(){this.ui.letterGrid=()=>document.getElementById("noticeletterlist-grid")}})}(window.kendo.jQuery,window.kendo);