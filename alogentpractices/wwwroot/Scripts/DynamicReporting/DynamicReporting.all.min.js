(function(n,t,i){i.mvvm||(i.mvvm={});i.mvvm.Model=i.data.Model.extend({init:function(){i.data.Model.fn.init.call(this)}});i.mvvm.View=i.Class.extend({init:function(n,i){var r=this;r.viewModel=i;t(document).ready(t.proxy(r._ready,r,t(n),i))},_ready:function(n,r){t("[data-role='pageload']").remove();i.ui.progress(n,!0);this.ready(n,r)},ready:function(n,t){i.bind(n,t);i.ui.progress(n,!1)}});i.mvvm.ViewModel=i.data.ObservableObject.extend({init:function(){i.data.ObservableObject.fn.init.call(this,this)}});i.mvvm.DialogViewModel=i.mvvm.ViewModel.extend({init:function(){ViewModel.fn.init.call(this)},triggerClose:function(n,t){this.trigger("close",{userTriggered:n,dialogResult:t})}});i.mvvm.DialogService=i.Class.extend({init:function(n){this.views=n},hasDialogOpen:!1,views:{},open:function(n,r){var o,c;if(!n)throw"Required [view] is missing.";var e=new t.Deferred,s=t("<div class='k-custom-dialog' />").kendoDialog({actions:r.actions,close:function(){this.destroy()}}),f=this.views[n],l=f.id,a=t(l).html(),u=s.data("kendoDialog"),h=t(i.template(a)(r.viewModel));if(u.content(h),f.cssClass){let n=u.element.closest(".k-dialog");t(n).addClass(f.cssClass)}if(f.cssContentClass){let n=s;t(n).addClass(f.cssContentClass)}return u.bind("close",function(n){e.state()!=="resolved"&&e.resolve({userTriggered:n.userTriggered,dialogResult:null})}),r.viewModel&&(i.bind(h,r.viewModel),r.viewModel instanceof i.mvvm.DialogViewModel&&r.viewModel.bind("close",function(n){e.resolve({userTriggered:n.userTriggered,dialogResult:n.dialogResult});u.close()})),r.title&&u.title(r.title),u.open(),this.hasDialogOpen=!0,r.opened&&t.proxy(r.opened(),this),o=e.promise(),c=this,o.always(function(){c.hasDialogOpen=!1}),o}});n.Model=i.mvvm.Model;n.ViewModel=i.mvvm.ViewModel;n.View=i.mvvm.View})(window,window.kendo.jQuery,window.kendo),function(n,t,i){t.data.ObservableGridColumn=t.data.ObservableObject.extend({init:function(n){t.data.ObservableObject.fn.init.call(this,this);this.set("field",n)},expandedField:i,field:i,title:i,hidden:!1,format:i,filterable:!1,template:i,width:150});t.data.binders.widget.grid.columns=t.data.Binder.extend({init:function(i,r,u){t.data.Binder.fn.init.call(this,i.element[0],r,u);this._options();this._columnResize=n.proxy(this.columnResize,this);this._columnShow=n.proxy(this.columnShow,this);this._columnHide=n.proxy(this.columnHide,this);this._columnReorder=n.proxy(this.columnReorder,this);this._columnChange=n.proxy(this.columnChange,this);i.bind("columnResize",this._columnResize);i.bind("columnShow",this._columnShow);i.bind("columnHide",this._columnHide);i.bind("columnReorder",this._columnReorder);this.widget=i;this._initChange=!1},change:function(i,r){var f;this._initChange=!0;var u=this,o=n(u.element).data("kendoGrid"),e=u.bindings.columns;if(e.source.columns){switch(r){case"reorder":u.columnFill&&u._moveColumnFill()}f=u._cloneArray(o.columns);e.get()instanceof t.data.ObservableArray&&(f=new t.data.ObservableArray(f));r==="reorder"&&u._moveArrayItem(f,i.oldIndex,i.newIndex);this.columnFill&&u._removeColumnFill(f);e.source.set("columns",f)}this._initChange=!1},columnChange:function(n){n.action==="itemchange"&&this.change(n)},columnFill:!1,columnResize:function(n){this.change(n)},columnShow:function(n){this.change(n)},columnHide:function(n){this.change(n)},columnReorder:function(n){this.change(n,"reorder")},destroy:function(){this.widget.unbind("columnResize",this._columnResize);this.widget.unbind("columnShow",this._columnShow);this.widget.unbind("columnHide",this._columnHide);this.widget.unbind("columnReorder",this._columnReorder)},refresh:function(){if(!this._initChange){var r=n(this.element).data("kendoGrid"),e=this.bindings.columns,u=e.get(),f=u instanceof t.data.ObservableArray?u.toJSON():u;this.columnFill&&this._addColumnFill(f);r._refreshOptions!==i&&r._refreshOptions===!1&&(r._refreshOptions=!0,r.setOptions({columns:f}),r._refreshOptions=!1);r._refreshOptions===i&&(r.setOptions({columns:f}),r._refreshOptions=!1)}},_cloneArray:function(t){var i=[];return n.each(t,function(n,t){i.push({field:t.field,hidden:t.hidden,template:t.template,filterable:t.filterable,format:t.format,width:t.width,title:t.title})}),i},_moveArrayItem:function(n,t,i){var r=n[t];n.splice(t,1);n.splice(i,0,r)},_moveColumnFill:function(){var t=n(this.element).data("kendoGrid"),i;n.each(t.columns,function(n,t){t.field===""&&(i=t)});setTimeout(function(){t.reorderColumn(t.columns.length-1,i)},0)},_options:function(){this.columnFill=n(this.element).data("columnFill")===!0},_addColumnFill:function(n){var r=new t.data.ObservableGridColumn("");r.width=i;n.push(r.toJSON())},_removeColumnFill:function(t){return n.each(t,function(n,i){if(i.field==="")return t.splice(n,1),!1}),!0}})}(window.kendo.jQuery,window.kendo);var CopyReportViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i,r){ViewModel.fn.init.call(this);this.manager=n;this.service=t;this.report=i;this.user=r;this.report=i},errorMessage:"",isBusy:!1,isValid:function(){return this.newReportName.length>0},newReportName:"",reportDescription:t,reportName:t,reportOwner:t,user:t,copy:function(){var n=this,t=n.service.copyReport(n.user,n.report.owner,n.report.name,n.newReportName);return t.fail(function(t){n.set("errorMessage",t.responseJSON.ErrorMessage)}),t}})}(window.kendo.jQuery),DateRangeFilterViewModel=function(n,t){return ViewModel.extend({init:function(n,t){ViewModel.fn.init.call(this);this.field=t;this.name=n;this.type="DateRange"},field:t,fromDate:null,toDate:null,type:t,filterType:0,isRelative:function(){return this.get("filterType")==1},isDate:function(){return this.get("filterType")==0},name:t,relativeValue:null,relativeType:0})}(window.kendo.jQuery),ReportService=function(){return kendo.Class.extend({init:function(n){this.api=n},api:undefined,copyReport:function(n,t,i,r){return this.api.post({controller:"DynamicReporting",action:"CopyReport",username:n,data:{Owner:t,ReportName:i,NewReportName:r}})},createReport:function(n,t,i,r){return this.api.post({controller:"DynamicReporting",action:"CreateReport",username:n,data:{Template:t,User:n,Name:i,Description:r}})},deleteReport:function(n,t){return this.api.post({controller:"DynamicReporting",action:"DeleteReport",username:n,data:{Name:t}})},emailReport:function(n,t,i,r){return this.api.post({controller:"DynamicReporting",action:"EmailReport",username:n,data:{User:n,ReportName:t,Users:r,Message:i}})},getData:function(n,t,i,r,u){return this.api.post({controller:"DynamicReporting",action:"GetReportData",username:n,data:{Fields:i,Skip:u.skip,Take:u.take,User:n,ReportName:t,Filters:r}})},getReportTemplate:function(n,t){return this.api.post({controller:"DynamicReporting",action:"GetReportTemplate",username:n,data:{User:n,ReportName:t}})},getReportDefinition:function(n,t){return this.api.post({controller:"DynamicReporting",action:"GetReportDefinition",username:n,data:{User:n,ReportName:t}})},getReportFilterData:function(n,t,i){return this.api.post({controller:"DynamicReporting",action:"GetReportFilterData",data:{User:n,ReportName:t,FieldName:i}})},getReportTemplates:function(n){return this.api.get({controller:"DynamicReporting",action:"GetTemplates",username:n})},getReportList:function(n){return this.api.get({controller:"DynamicReporting",action:"GetUserReportList",username:n})},getSharedUsers:function(n,t){return this.api.post({controller:"DynamicReporting",action:"GetSharedUsers",data:{UserName:n,ReportName:t}})},getUsers:function(n){return this.api.post({controller:"DynamicReporting",action:"GetUsers",data:{UserName:n}})},getUserPermissions:function(n){return this.api.get({controller:"DynamicReporting",action:"GetUserPermissions",username:n})},shareReport:function(n,t,i,r){return this.api.post({controller:"DynamicReporting",action:"ShareReport",data:{ReportName:t,IsShared:i,Users:r},username:n})},updateReport:function(n,t,i,r,u,f,e){return this.api.post({controller:"DynamicReporting",action:"UpdateReport",username:n,data:{ReportName:t,NewReportName:i,Description:r,Fields:u,Groups:f,Filters:e}})}})}(),EmailReportViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i){ViewModel.fn.init.call(this);this.service=n;this.user=t;this.report=i;this.set("users",this._dataSource())},message:t,user:t,users:t,selectedUsers:[],showDialog:t,_dataSource:function(){var n=this;return new kendo.data.DataSource({transport:{read:{url:n.report.isSharedBankwide?"api/DynamicReporting/GetUsers":"api/DynamicReporting/GetSharedUsers",type:"POST"},parameterMap:function(){return n.report.isSharedBankwide?{UserName:n.user}:{UserName:n.user,ReportName:n.report.name}}},schema:{data:function(t){return n._users(t.Users)}},group:{field:"group"}})},_getFullName:function(n){return(n.FirstName==null||n.FirstName.length===0)&&(n.LastName==null||n.LastName.length===0)?null:n.LastName==null||n.LastName.length<1?n.FirstName:n.FirstName==null||n.FirstName.length<1?n.LastName:n.FirstName+" "+n.LastName},_getGroup:function(n){return n.LastName===t||n.LastName.length===0?"":n.LastName[0].toLowerCase()},_getLabel:function(n){var i=this._getFullName(n);return i===null?n.Email==null?n.UserName:n.Email+" ("+n.UserName+")":n.Email===t||n.Email.length===0?i+" ("+n.UserName+")":i+" ("+n.Email+")"},_users:function(t){var i=this,r=new kendo.data.ObservableArray([]);return n.each(t,function(n,t){r.push({userName:t.UserName,fullName:i._getFullName(t),email:t.Email,label:i._getLabel(t),group:i._getGroup(t)})}),r}})}(window.kendo.jQuery),FilterViewModel=function(n,t){return ViewModel.extend({init:function(n,t){ViewModel.fn.init.call(this);this.api=n;this.field=t;this.options=this._options();this.set("selectedOption",{value:"Search"})},isDateRangeSelected:function(){return this.get("selectedOption").value==="DateRange"},isSearchSelected:function(){return this.get("selectedOption").value==="Search"},isMultiSelected:function(){return this.get("selectedOption").value==="Multi"},options:t,selectedOption:null,_options:function(){var n=new kendo.data.ObservableArray([{name:"Search",value:"Search"},{name:"Multi-select List",value:"Multi"}]);return this.field.type==="DateTime"&&n.push({name:"Date Range",value:"DateRange"}),n}})}(window.kendo.jQuery),FilterSerializer=function(){return kendo.Class.extend({init:function(n){this.serialize(n)},serialize:function(n){var t={SearchFilters:[],MultiFilters:[],DateFilters:[],DateRangeFilters:[]};return $.each(n,function(n,i){var u,f,r;switch(i.type){case"DateRange":u={Field:i.field,FromDate:i.fromDate,ToDate:i.toDate,FilterType:i.filterType,RelativeType:i.relativeType,RelativeValue:i.relativeValue};t.DateRangeFilters.push(u);break;case"Search":f={Field:i.field,Operator:i.operator,Value:i.value};t.SearchFilters.push(f);break;case"Multi":r={Field:i.field,Values:[]};$.each(i.items,function(n,t){typeof MultiFilterEditViewModel!="undefined"&&i instanceof MultiFilterEditViewModel?t.isSelected===!0&&r.Values.push(t.value):i instanceof MultiFilterViewModel&&r.Values.push(t.value)});t.MultiFilters.push(r)}}),t}})}(),ImportReportViewModel=function(n,t){return ViewModel.extend({init:function(n,t){ViewModel.fn.init.call(this);this.service=n;this.user=t},user:t,canUpload:function(){return this.get("name").length>0},onError:function(n){var t=this.get("errors"),i;t.splice(0,t.length);i=JSON.parse(n.XMLHttpRequest.response);t.push(i.ErrorMessage);this.set("hasError",!0)},onSuccess:function(t){var i=this.get("errors");i.splice(0,i.length);t.response.Success?(this.set("hasError",!1),this.trigger("upload")):(n.each(t.response.Errors,function(n,t){i.push(t)}),this.set("hasError",!0))},onUpload:function(n){var i=this,t=n.XMLHttpRequest;t.addEventListener("readystatechange",function(){t.readyState===1&&(t.setRequestHeader("x-accuaccount-username",i.user),t.setRequestHeader("x-accuaccount-reportname",i.name))})},errors:[],hasError:!1,name:""})}(window.kendo.jQuery),MultiFilterViewModel=function(n,t){return ViewModel.extend({init:function(n,t){ViewModel.fn.init.call(this);this.name=n;this.field=t},add:function(n){this.items.push(kendo.observable({value:n}))},field:t,items:[],name:t,type:"Multi"})}(window.kendo.jQuery),MultiFilterEditViewModel=function(n){return MultiFilterViewModel.extend({init:function(n,t){MultiFilterViewModel.fn.init.call(this,n,t)},add:function(n){this.items.push(kendo.observable({value:n,isSelected:!1}))},limit:500,exceedsLimit:function(){return this.get("items").length>=this.limit},isBusy:!1,selectValue:function(t){n.each(this.items,function(n,i){if(i.value===t)return i.set("isSelected",!0),!1})}})}(window.kendo.jQuery),NewReportViewModel=function(n,t){return ViewModel.extend({init:function(n,t){ViewModel.fn.init.call(this);this.service=n;this.user=t;this.set("templates",this._templates())},create:function(){var t=this,i=t.service.createReport(t.user,t.selectedTemplate.name,t.name,t.description);return i.done(function(i){t.set("errors",[]);t.set("hasErrors",!1);i.Errors.length>0?(t.set("hasErrors",!0),n.each(i.Errors,function(n,i){t.errors.push(i)})):(t.set("result","created"),t.set("hasErrors",!1))}),i},description:"",errors:new kendo.data.ObservableArray([]),hasErrors:!1,name:"",resizeWindow:t,result:"none",selectedTemplate:t,templates:t,user:t,_templates:function(){var t=this;return new kendo.data.DataSource({transport:{read:function(n){var i=t.service.getReportTemplates(t.user);i.done(function(t){n.success(t)});i.fail(function(t){n.error(t)})}},schema:{data:function(t){var i=[];return n.each(t.Templates,function(n,t){var r;r=new ReportTemplateViewModel(t.Name,t.Description,t.IsLicensed);i.push(r)}),i}},change:function(){var n=t.templates.view();n.length>0&&t.set("selectedTemplate",n[0])}})}})}(window.kendo.jQuery),ReportViewModel=function(n,t){return ViewModel.extend({init:function(n){ViewModel.fn.init.call(this);this._service=n;this._canRead=!0},behaviors:new kendo.data.ObservableArray([]),columns:[],data:t,filters:[],isLicensed:!0,name:t,owner:t,pageSize:25,template:t,view:function(t,i){var r=this;return r.set("owner",t),r.set("name",i),n.when(r._service.getReportTemplate(t,i),r._service.getReportDefinition(t,i)).then(function(t,i){return n.proxy(r._initialize,r,t[0],i[0])()})},_createColumn:function(n,t){var r=this,i=new kendo.data.ObservableGridColumn(t.name);return t.behaviors.linkBehavior.isSupported&&t.behaviors.linkBehavior.isEnabled&&i.set("field",t.name+".Value"),i.title=r._getFieldLabel(n,t),i.hidden=!1,i.format=r._getColumnFormat(t),i.template=r._getColumnTemplate(t),i},_data:function(t,i,r,u){var f=this,e={};return n.each(t,function(t,i){n.each(i.fields,function(n,t){e[t.name]={type:f._getFieldType(t)}})}),new kendo.data.DataSource({transport:{read:function(t){n.proxy(f._read,f)(t)}},schema:{data:"Data",total:"Total",model:{fields:e}},pageSize:u,serverGrouping:!1,serverPaging:!0,serverFiltering:!0,serverSorting:!0,sort:r,group:i})},_getColumnName:function(n){return n.indexOf(".")>-1?n.substr(0,n.indexOf(".")):n},_getColumn:function(t){var i,r=this;return n.each(this.columns,function(n,u){return r._getColumnName(u.field)===r._getColumnName(t)?(i=u,!1):!0}),i},_getColumnFormat:function(n){switch(n.type){case"DateTime":return"{0:MM/dd/yyyy hh:mm:ss tt}";case"Money":return"{0:c2}";default:return t}},_getColumns:function(t,i){var f=this,r=[],u=[];return n.each(t,function(t,i){n.each(i.fields,function(n,t){u.push(t)})}),n.each(i,function(i,e){n.each(u,function(n,u){if(e.name===u.name){var o=f._createColumn(t,u);return o.width=e.width,r.splice(i,0,o),!1}})}),r},_getColumnTemplate:function(n){if(n.behaviors.linkBehavior.isSupported)return n.behaviors.linkBehavior.isEnabled?"<a href='#= "+n.name+".Link #'><span data-bind='text: "+n.name+".Value'><\/span><\/a>":t;switch(n.type){case"True/False":return"#= "+n.name+' == true ? "Y" : "N"#';default:return t}},_getDateRangeFilters:function(t,i){var r=this,u=[];return n.each(i,function(n,i){var e=r._getTemplateField(t,i.Field),o=r._getFieldLabel(t,e),f=new DateRangeFilterViewModel(o,i.Field);f.set("fromDate",i.FromDate);f.set("toDate",i.ToDate);f.set("filterType",i.FilterType);f.set("relativeType",i.RelativeType);f.set("relativeValue",i.RelativeValue);u.push(f)}),u},_getFields:function(t){var i=[];return n.each(t,function(n,t){var r=new ReportField(t.Name,t.SortOrder,t.SortDirection,t.Width);r.behaviors.linkBehavior=t.Behaviors.LinkBehavior;i.push(r)}),i},_getFieldType:function(n){if(n.behaviors.linkBehavior.isSupported&&n.behaviors.linkBehavior.isEnabled)return"object";switch(n.type){case"True/False":return"boolean";case"DateTime":return"date";case"Money":return"number";case"Number":return"number";default:return"string"}},_getFilters:function(n,t){var i=this._getSearchFilters(n,t.SearchFilters),r=this._getDateRangeFilters(n,t.DateRangeFilters),u=this._getMultiFilters(n,t.MultiFilters);return[].concat.apply([],[i,r,u])},_getFieldLabel:function(t,i){var r=i.label;return n.each(t,function(t,u){n.each(u.fields,function(n,t){i.group!==u.name&&i.label===t.label&&(r=i.label+" ("+i.group+")")})}),r},_getGroups:function(t){var i=[];return n.each(t,function(n,t){i.push({field:t.Name,dir:t.SortDirection===1?"desc":"asc"})}),i},_getMultiFilterPromise:function(t,i){return n.each(t,function(t,r){r.Field===i.field&&n.each(r.Values,function(n,t){i.add(t)})}),(new n.Deferred).resolve()},_getMultiFilters:function(t,i){var r=this,u=[];return n.each(i,function(n,i){var f=r._getTemplateField(t,i.Field),e=r._getFieldLabel(r.template,f),o=new MultiFilterViewModel(e,f.name);u.push(o)}),u},_getSearchFilters:function(t,i){var r=this,u=[];return n.each(i,function(n,i){var e=r._getTemplateField(t,i.Field),o=r._getFieldLabel(t,e),f=new SearchFilterViewModel(o,i.Field,e.type);f.set("operator",i.Operator);f.set("value",i.Value);u.push(f)}),u},_getSortDescriptions:function(t,i){var r=[],u=this,f=i.sort(function(n,t){return n.sortOrder<t.sortOrder?-1:n.sortOrder>t.sortOrder?1:0});return n.each(f,function(n,i){if(i.sortOrder!==-1){var f=u._getTemplateField(t,i.name),e;e=f.behaviors.linkBehavior.isSupported===!0&&f.behaviors.linkBehavior.isEnabled?kendo.format("{0}.Value",i.name):i.name;r.push({field:e,dir:i.sortDirection===1?"desc":"asc"})}}),r},_getSortDirection:function(n){switch(n){case 0:return"asc";case 1:return"desc";default:return"asc"}},_getSortDirectionInt:function(n){switch(n){case"asc":return 0;case"desc":return 1;default:return-1}},_getTemplate:function(t,i){var r=[];return n.each(t,function(t,u){var f=new ReportTemplateGroupViewModel(u.Name);n.each(u.Fields,function(t,r){var u=new ReportTemplateFieldViewModel(f.name,r.Name,r.Label,r.Type);u.behaviors.linkBehavior.set("isSupported",r.Behaviors.LinkBehavior);n.each(i,function(n,t){t.name===r.Name&&(u.set("checked",!0),u.behaviors.linkBehavior.isSupported===!0&&t.behaviors.linkBehavior!==null?u.behaviors.linkBehavior.set("isEnabled",!0):u.behaviors.linkBehavior.set("isEnabled",!1))});f.fields.push(u)});r.push(f)}),r},_getTemplateField:function(t,i){var r;return n.each(t,function(t,u){return n.each(u.fields,function(n,t){if(t.name===i)return r=t,!1}),r?!1:void 0}),r},_initialize:function(t,i){var r=this,s=r._getGroups(i.Groups),f=r._getFields(i.Fields),u=r._getTemplate(t.Groups,f),h=new kendo.data.ObservableArray(r._getColumns(u,f)),c=r._getSortDescriptions(u,f),e,o;return r.set("template",u),r.set("data",this._data(u,s,c,r.pageSize)),r.set("columns",h),r.set("filters",r._getFilters(r.template,i.Filters)),r.set("isLicensed",t.IsLicensed),e=[],n.each(r.filters,function(n,t){t.type==="Multi"&&e.push(r._getMultiFilterPromise(i.Filters.MultiFilters,t))}),o=new n.Deferred,n.when.apply(n,e).then(function(){o.resolve()}),o},_read:function(n){if(this._canRead===!1)return n.success([]);var t=this,r=new FilterSerializer,u=r.serialize(t.filters),f=t._serializeColumns(t.columns,n.data.sort),i=t._service.getData(t.owner,t.name,f,u,n.data);i.fail(function(t){n.error(t)});i.done(function(t){n.success(t)})},_serializeBehaviors:function(n){var t={linkBehavior:null};return n.behaviors.linkBehavior.isSupported===!0&&n.behaviors.linkBehavior.isEnabled===!0&&(t.linkBehavior={}),t},_serializeColumns:function(t,i){var u=[],r=this,f;return n.each(t,function(t,i){var f=new ReportField(i.field,-1,-1,i.width);n.each(r.template,function(t,u){n.each(u.fields,function(n,t){var u=r._getColumnName(i.field);t.name===u&&t.behaviors.linkBehavior.isSupported===!0&&t.behaviors.linkBehavior.isEnabled===!0&&(f.name=u,f.behaviors=r._serializeBehaviors(t))})});u.push(f)}),f=0,n.each(i,function(t,i){return n.each(u,function(n,t){var u=r._getColumnName(i.field);if(u===t.name){switch(i.dir){case"asc":t.sortDirection=0;break;case"desc":t.sortDirection=1}return t.sortOrder=++f,!1}return!0}),!0}),u},_service:t})}(window.kendo.jQuery),ReportEditorViewModel=function(n,t){var i="save";return ReportViewModel.extend({init:function(n,t,i,r){ReportViewModel.fn.init.call(this,n);this.set("description",i);this.set("isShared",!t);this.set("pageSize",100);this.canExport(r)},canExport:function(n){if(n!==t)this._canExport=n&&this.get("isLicensed");else return this._canExport&&this.get("isLicensed")},currentName:t,description:t,editFilter:function(i){var r=this;if(i.stopPropagation(),!r.isBusy){var u=i.data,f=new n.Deferred,e=new FilterViewModel(r._service,u),o={viewModel:e,result:f,filter:t};r.trigger("filter",o);f.then(function(){var n=t,i=r._getFieldLabel(r.template,u);switch(e.selectedOption.value){case"DateRange":n=new DateRangeFilterViewModel(i,u.name);break;case"Search":n=new SearchFilterViewModel(i,u.name,u.type);n.set("value","");break;case"Multi":n=new MultiFilterEditViewModel(i,u.name);r._getMultiFilterItems(r._service,r.owner,r.name,n)}r.filters.push(n)})}},error:t,exportData:function(n){var t=this;n.stopPropagation();t.save().done(function(){t.trigger("export",{report:t})})},_getMultiFilterItems:function(t,i,r,u){var e=this,f;return e.set("isBusy",!0),e.set("items",[]),f=t.getReportFilterData(i,r,u.field),f.done(function(t){var i=[],r={};n.each(t.Data,function(n,t){t.Value||(t.Value="");r[t.Value]=t});n.each(r,function(n,t){i.push(t)});i.sort(function(n,t){return n.Value.localeCompare(t.Value)});n.each(i,function(n,t){u.add(t.Value)})}),f.always(function(){e.set("isBusy",!1)}),f},_getMultiFilters:function(t,i){var r=this,u=[];return n.each(i,function(n,i){var f=r._getTemplateField(t,i.Field),e=r._getFieldLabel(r.template,f),o=new MultiFilterEditViewModel(e,f.name);u.push(o)}),u},_getMultiFilterPromise:function(t,i){var r=this;return r._getMultiFilterItems(r._service,r.owner,r.name,i).then(function(){n.each(t,function(t,r){r.Field===i.field&&n.each(r.Values,function(n,t){i.selectValue(t)})})})},hasError:!1,hasColumns:function(){var t=this.get("columns"),i=n.grep(t,function(n){return n.hidden===!1&&n.field!==""});return i.length>0},hasFilters:function(){return this.get("filters").length>0},isBusy:!1,isShared:t,view:function(n,t){var i=this;return i.set("currentName",t),ReportViewModel.fn.view.call(i,n,t).done(function(){i.refresh()})},refresh:function(){var n=this,t;return(n._toggleIsBusy(!0),!n.hasColumns())?(n._toggleIsBusy(!1),null):(t=n.data.fetch(),t.done(function(){n._hideError()}),t.fail(function(t){n._showError(t.responseJSON.ErrorMessage)}),t.always(function(){setTimeout(function(){n._toggleIsBusy(!1)})}),t)},removeFilter:function(n){var t=this,i=t.filters.indexOf(n.data);t.filters.splice(i,1)},save:function(){var n=this;n._toggleIsBusy(!0);var r=n._serializeGroups(n.data.group()),u=n.data.sort(),f=n._serializeColumns(n.columns,u),e=new FilterSerializer,o=e.serialize(n.filters),t=n._service.updateReport(n.owner,n.name,n.currentName,n.description,f,r,o);return t.fail(function(t){n._showError(t.responseJSON.ErrorMessage)}),t.done(function(){n._hideError();n.trigger(i,n);n.set("name",n.currentName)}),t.always(function(){setTimeout(function(){n._toggleIsBusy(!1)},25)}),t},toggleColumn:function(n){var t=this,i;if(t._toggleIsBusy(!0),n.data.checked?t._showColumn(n.data.name):t._hideColumn(n.data.name),!t.hasColumns()){t.data.data([]);t._toggleIsBusy(!1);return}i=t._isColumnSorted(n.data.name);n.data.checked||!i?t.refresh():t.data.sort(t._removeColumnSortConfiguration(n.data.name));t._toggleIsBusy(!1)},toggleBehavior:function(n){var t=this,i;t._toggleIsBusy(!0);i=n.target.dataset.behaviortype;switch(i){case"link":t._toggleLinkBehavior(n.data,n.data.behaviors.linkBehavior,t.data)}t.refresh().done(function(){t._toggleIsBusy(!1)})},_getDataSourceGroup:function(t,i){var r;return n.each(t,function(n,t){return t.field===i?(r=t,!1):!0}),r},_hideColumn:function(n){var t=this,i=t._getColumn(n),r;i&&(t._canRead=!1,t._ungroupColumn(i.field),t._canRead=!0,r=t.columns.indexOf(i),t.columns.splice(r,1))},_hideError:function(){var n=this;n.set("hasError",!1);n.set("error","")},_isColumnSorted:function(n){var u=this,t=u.data.sort(),r,i;if(t==null||t.length===0)return!1;for(r=!1,i=0;i<t.length;i++)if(t[i].field.toLowerCase()===n.toLowerCase()){r=!0;break}return r},_removeColumnSortConfiguration:function(n){for(var t=this.data.sort(),r=-1,i=0;i<t.length;i++)if(t[i].field.toLowerCase()===n.toLowerCase()){r=i;break}return r!==-1&&t.splice(r,1),t},_serializeGroups:function(t){var i=[];return n.each(t,function(n,t){var r;switch(t.dir){case"asc":r=0;break;case"desc":r=1;break;default:r=-1}i.push(new ReportGroup(t.field,r))}),i},_showColumn:function(n){var t=this,i=t._getTemplateField(t.template,n),r=t._createColumn(t.template,i);t.columns.push(r)},_showError:function(n){var t=this;t.set("hasError",!0);t.set("error",n)},_toggleIsBusy:function(n){this.set("isBusy",n);this.trigger("busy",{isBusy:this.get("isBusy")})},_disableLinkBehavior:function(n,t,i){var f=this,r=i.options,u;r.group=i.group();u=f._getDataSourceGroup(r.group,kendo.format("{0}.Value",n.name));u&&(u.field=n.name);r.schema.model.fields[n.name]={type:"string"};f.set("data",new kendo.data.DataSource(r));t.set("field",n.name)},_enableLinkBehavior:function(n,t,i){var f=this,r=i.options,u;r.group=i.group();u=f._getDataSourceGroup(r.group,n.name);u&&(u.field=kendo.format("{0}.Value",n.name));r.schema.model.fields[n.name]={type:"object"};f.set("data",new kendo.data.DataSource(r));t.set("field",kendo.format("{0}.Value",n.name))},_toggleLinkBehavior:function(n,t,i){var r=this,u,f;t.isEnabled===!0?(u=r._getColumn(kendo.format("{0}.Value",n.name)),r._disableLinkBehavior(n,u,i)):(u=r._getColumn(n.name),r._enableLinkBehavior(n,u,i));t.set("isEnabled",!t.isEnabled);f=r._getColumnTemplate(n);u.set("template",f)},_ungroupColumn:function(n){var f=this,t=this.data,i=t.group(),r=f._getDataSourceGroup(t.group(),n),u;r&&(u=i.indexOf(r),i.splice(u,1),t.group(i))}})}(window.kendo.jQuery),ReportField=kendo.Class.extend({init:function(n,t,i,r){this.name=n;this.sortOrder=t;this.sortDirection=i;this.width=Math.floor(r);this.behaviors={linkBehavior:null}},name:undefined,sortOrder:undefined,sortDirection:undefined,width:undefined,behaviors:undefined}),ReportGroup=function(){return kendo.Class.extend({init:function(n,t){this.name=n;this.sortDirection=t},name:undefined,sortDirection:undefined})}(),ReportBehavior=kendo.data.Model.extend({init:function(n,t){kendo.data.Model.fn.init.call(this);this.id=n;this.field=t},id:undefined,field:undefined}),ReportManagerViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i){ViewModel.fn.init.call(this);this.service=n;this.user=t;this.isPurchased=i},addReport:function(n,t){this.userReports.push(n);this.set("numberUserReports",this.numberUserReports+1);t&&this.openReport({data:n})},addSharedReport:function(n){this.sharedReports.push(n);this.set("numberSharedReports",this.numberSharedReports+1)},copyReport:function(t){t.stopPropagation();var i=this,r=new n.Deferred,u=t.data,f=new CopyReportViewModel(i,i.service,u,i.user);i.trigger("copy",{viewModel:f,result:r});r.then(function(n){var t=new ReportTileViewModel(n,u.description,i.user,!0,!1,!1,i.isPurchased,i.canExport,i.canShare,i.canCreate,i.canEmail);i.addReport(t,!1)})},createReport:function(){var t=this,i=new NewReportViewModel(t.service,t.user),r=new n.Deferred;t.trigger("create",{result:r,viewModel:i});r.then(function(){var n=new ReportTileViewModel(i.name,i.description,t.user,!0,!1,!1,t.isPurchased,t.canExport,t.canShare,t.canCreate,t.canEmail);t.addReport(n,!0)})},deleteReport:function(t){t.stopPropagation();var i=this,r=t.data,u=new n.Deferred;i.trigger("delete",{user:i.user,report:r,result:u});u.then(function(){i.service.deleteReport(i.user,r.name).done(function(){i.removeReport(r)})})},downloadReport:function(n){n.stopPropagation();window.location.replace(kendo.format("api/DynamicReporting/DownloadReport?UserName={0}&ReportName={1}",n.data.owner,n.data.name))},emailReport:function(t){t.stopPropagation();var i=this,r=t.data,f=new n.Deferred,u=new EmailReportViewModel(i.service,i.user,r);i.trigger("email",{result:f,viewModel:u});f.then(function(){var f=[],t;n.each(u.selectedUsers,function(n,t){f.push(t.userName)});t=i.findReport(r.name);t.set("isBusy",!0);i.service.emailReport(i.user,r.name,u.message,f).done(function(){t.set("isBusy",!1)})})},exportReport:function(n){n.stopPropagation();this.trigger("export",{report:n.data})},findReport:function(t){var i=null,r=this.get("userReports");return n.each(r,function(n,r){if(r.name.toLowerCase()===t.toLowerCase())return i=r,!1}),i},findSharedReport:function(t,i){var r=null,u=this.get("sharedReports");return n.each(u,function(n,u){if(u.name.toLowerCase()===t.toLowerCase()&&u.owner.toLowerCase()===i.toLowerCase())return r=u,!1}),r},importReport:function(){var t=this,i=new ImportReportViewModel(t.service,t.user),r=new n.Deferred;t.trigger("import",{result:r,viewModel:i});r.then(function(){var n=new ReportTileViewModel(i.name,"",t.user,!0,!1,!1,t.isPurchased,t.canExport,t.canShare,t.canCreate,t.canEmail);t.addReport(n,!1)})},isPurchased:t,load:function(){var t=this,i=t.service.getUserPermissions(t.user).done(function(n){t.set("canCreate",n.CanCreateReports);t.set("canExport",n.CanExportReports);t.set("canShare",n.CanShareReports);t.set("canEmail",n.CanEmail)}),r=n.when(i).then(function(){return t.service.getReportList(t.user).done(function(i){n.each(i.Items,function(n,i){t.addReport(new ReportTileViewModel(i.Name,i.Description,i.Owner,i.IsOwned,i.IsShared,i.IsSharedBankwide,t.isPurchased,t.canExport,t.canShare,t.canCreate,t.canEmail),!1)});n.each(i.SharedItems,function(n,i){t.addSharedReport(new ReportTileViewModel(i.Name,i.Description,i.Owner,i.IsOwned,i.IsShared,i.IsSharedBankwide,t.isPurchased,t.canExport,t.canShare,t.canCreate,t.canEmail),!1)})})});return n.when(r)},numberSharedReports:0,numberUserReports:0,openReport:function(n){var t=this,i=new ReportEditorViewModel(t.service,n.data.isOwned,n.data.description,t.canExport,t.isPurchased);i.view(n.data.owner,n.data.name).done(function(){t.trigger("open",{report:i,isOwner:n.data.isOwned})})},removeReport:function(n){var t=this.userReports.filter(function(t){return t.name!==n.name});this.set("userReports",t);this.set("numberUserReports",this.numberUserReports-1)},sharedReports:[],shareReport:function(t){t.stopPropagation();var i=this,u=t.data,f=new n.Deferred,r=new ShareReportViewModel(i.service,i.user,u);i.service.getSharedUsers(i.user,u.name).done(function(n){r.select(n.Users,n.IsSharedBankwide);i.trigger("share",{result:f,viewModel:r})});f.then(function(){var e=[],f;n.each(r.selectedUsers,function(n,t){e.push(t.userName)});f=i.findReport(t.data.name);f.set("isBusy",!0);i.service.shareReport(i.user,u.name,r.isSharedBankwide,e).done(function(){u.set("isShared",r.isSharedBankwide||r.selectedUsers.length>0);u.set("isSharedBankwide",r.isSharedBankwide);f.set("isBusy",!1)})})},updateTile:function(t){n.each(this.userReports,function(n,i){i.name===t.name&&(i.set("name",t.currentName),i.set("description",t.description))})},userReports:[],user:t,canDownload:t,canCreate:!1,canExport:!1,canShare:!1})}(window.kendo.jQuery),ReportTemplateFieldBehaviorViewModel=function(){return ViewModel.extend({init:function(){ViewModel.fn.init.call(this)},isAvailable:!1,isEnabled:!1,isSupported:!1})}(window.kendo.jQuery),ReportTemplateFieldViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i,r){ViewModel.fn.init.call(this);this.group=n;this.name=t;this.label=i;this.type=r;this.set("behaviors",new kendo.data.ObservableObject({linkBehavior:new ReportTemplateFieldBehaviorViewModel}));this.bind("change",this._change)},group:t,name:t,label:t,type:t,checked:t,behaviors:t,_change:function(n){n.field==="checked"&&this.behaviors.linkBehavior.set("isAvailable",this.checked===!0&&this.behaviors.linkBehavior.isSupported===!0)}})}(window.kendo.jQuery),ReportTemplateGroupViewModel=function(n,t){return ViewModel.extend({init:function(n){ViewModel.fn.init.call(this);this.name=n;this.fields=[]},name:t,fields:t})}(window.kendo.jQuery),ReportTemplateViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i){ViewModel.fn.init.call(this);this.name=n;this.description=t;this.isPurchased=i},name:t,description:t,isPurchased:t})}(window.kendo.jQuery),ReportTileViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i,r,u,f,e,o,s,h,c){ViewModel.fn.init.call(this);this.description=t;this.name=n;this.isBusy=!1;this.isOwned=r;this.isShared=u;this.isSharedBankwide=f;this.owner=i;this.isPurchased=e;this.userCanCreate=h;this.userCanExport=o;this.userCanShare=s;this.userCanSendMail=c},description:t,name:t,isBusy:t,isOwned:t,isShared:t,isSharedBankwide:t,owner:t,isPurchased:t,canCopy:function(){return this.get("isPurchased")&&this.get("userCanCreate")&&!this.get("isBusy")},canEmail:function(){return this.get("userCanSendMail")?this.get("isPurchased")&&this.get("userCanShare")&&!this.get("isBusy"):!1},canExport:function(){return this.get("isPurchased")&&this.get("userCanExport")&&!this.get("isBusy")},canDownload:function(){return this.get("isPurchased")&&this.get("userCanCreate")&&!this.get("isBusy")},canShare:function(){return this.get("isPurchased")&&this.get("userCanShare")&&!this.get("isBusy")},userCanCreate:t,userCanExport:t,userCanShare:t,userCanSendMail:t})}(window.kendo.jQuery),SearchFilterViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i){ViewModel.fn.init.call(this);this.field=t;this.fieldType=i;this.name=n;this.value=this.getDefaultValue(i);this.operators=this.getOperators(i);this.operator=this.getDefaultOperator(i)},field:t,fieldType:t,getDefaultOperator:function(n){switch(n){case"Text":return"Contains";default:return"="}},getDefaultValue:function(n){switch(n){case"True/False":return"True";default:return null}},getOperators:function(n){switch(n){case"True/False":return["="];case"Text":return["Starts With","Contains","Ends With","="];default:return["<","<=","=",">",">="]}},name:t,operator:t,operators:t,type:"Search",value:t})}(window.kendo.jQuery),ShareReportViewModel=function(n,t){return ViewModel.extend({init:function(n,t,i){ViewModel.fn.init.call(this);this.service=n;this.user=t;this.report=i;this.set("users",this._dataSource())},_dataSource:function(){var n=this;return new kendo.data.DataSource({transport:{read:{url:"api/DynamicReporting/GetUsers",type:"POST"},parameterMap:function(){return{UserName:n.user}}},schema:{data:function(t){return n._users(t.Users)}},group:{field:"group"}})},isSharedBankwide:t,user:t,users:t,select:function(n,t){this.set("selectedUsers",this._users(n));this.set("isSharedBankwide",t)},selectedUsers:[],showDialog:t,_getFullName:function(n){return(n.FirstName==null||n.FirstName.length===0)&&(n.LastName==null||n.LastName.length===0)?null:n.LastName==null||n.LastName.length<1?n.FirstName:n.FirstName==null||n.FirstName.length<1?n.LastName:n.FirstName+" "+n.LastName},_getGroup:function(n){return n.LastName===t||n.LastName.length===0?"":n.LastName[0].toLowerCase()},_getLabel:function(n){var i=this._getFullName(n);return i===null?n.Email==null?n.UserName:n.Email+" ("+n.UserName+")":n.Email===t||n.Email.length===0?i+" ("+n.UserName+")":i+" ("+n.Email+")"},_users:function(t){var i=this,r=new kendo.data.ObservableArray([]);return n.each(t,function(n,t){var u={userName:t.UserName,fullName:i._getFullName(t),email:t.Email,label:i._getLabel(t),group:i._getGroup(t)};r.push(u)}),r}})}(window.kendo.jQuery),ReportView=View.extend({init:function(n,t,i,r,u){View.fn.init.call(this,n,t);this._webapi=i;this._reportName=r;this._reportOwner=u},ready:function(n,t){var i=this;i._ui(n,t);i._events(t);t.load().done(function(){if(View.fn.ready.call(i,n,t),i._reportName){var r=t.findSharedReport(i._reportName,i._reportOwner);r!==null&&t.openReport({data:r})}})},_events:function(){this.viewModel.bind("create",$.proxy(this._createReport,this));this.viewModel.bind("open",$.proxy(this._openReport,this));this.viewModel.bind("copy",$.proxy(this._copyReport,this));this.viewModel.bind("delete",$.proxy(this._deleteReport,this));this.viewModel.bind("email",$.proxy(this._emailReport,this));this.viewModel.bind("export",$.proxy(this._exportReport,this));this.viewModel.bind("import",$.proxy(this._importReport,this));this.viewModel.bind("share",$.proxy(this._shareReport,this));$(document).on("click",".r-cardheader",$.proxy(this._toggleCard,this))},_copyReport:function(n){var i={title:"Copy Report",closable:!1,modal:!0,content:kendo.template($("#rm-copy-prompt-template").html()),actions:[{text:"OK",primary:!0,action:function(t){var i=n.viewModel.copy();return i.fail(function(){$("#rm-copy-name").focus()}),i.done(function(){n.result.resolve(n.viewModel.newReportName);t.sender.close()}),!1}},{text:"Cancel"}],close:function(){this.destroy()}},t=$("<div><\/div>").kendoDialog(i).data("kendoDialog");kendo.bind($(t.element),n.viewModel);t.open();$("#rm-copy-name").focus()},_createReport:function(n){var i={width:"450px",title:"New Report",visible:!1,content:kendo.template($("#nr-window-template").html()),actions:[{text:"Create",action:function(t){var i=n.viewModel.create();return i.done(function(i){i.Errors.length===0&&(t.sender.close(),n.result.resolve())}),!1},primary:!0},{text:"Cancel"}],close:function(){this.destroy()}},t=$("<div><\/div>").kendoDialog(i).data("kendoDialog");kendo.bind(t.element,n.viewModel);t.open();$("#nr-name").focus()},_deleteReport:function(n){var t=kendo.template($("#dr-template").html()),i={name:n.report.name};kendo.confirm(t(i)).done(function(){n.result.resolve()})},_emailReport:function(n){var i={title:"Email Report",closable:!1,modal:!0,content:kendo.template($("#er-window-template").html()),width:500,actions:[{text:"OK",primary:!0,action:function(){n.result.resolve()}},{text:"Cancel"}],close:function(){this.destroy()}},t=$("<div><\/div>").kendoDialog(i).data("kendoDialog");kendo.bind($(t.element),n.viewModel);t.open()},_exportReport:function(n){kendo.prompt(kendo.template($("#rm-export-prompt-template").html())).then(function(t){window.location.replace(kendo.format("api/DynamicReporting/ExportReport?UserName={0}&ReportName={1}&ExportName={2}",n.report.owner,n.report.name,t))})},_focus:function(n,t){setTimeout(function(){switch(t){case"filters":$("#r-properties-scrollable").animate({scrollTop:$("#r-properties-scrollable").height()})}})},_importReport:function(n){var r={title:"Import Report",closable:!1,modal:!0,content:kendo.template($("#ir-window-template").html()),width:500,actions:[{text:"Cancel"}],close:function(){this.destroy()}},i=$("<div><\/div>").kendoDialog(r).data("kendoDialog"),t=null;t=function(){i.close();t!==null&&(n.viewModel.unbind("upload",t),n.result.resolve())};n.viewModel.bind("upload",t);kendo.bind($(i.element),n.viewModel);i.open();$("#ir-name").focus()},_isBusyChanged:function(n){n.isBusy?($("#r-panel a").attr("disabled","disabled"),$("#r-panel input").prop("disabled",!0),$("#r-panel textarea").prop("disabled",!0),$("#r-panel label").attr("disabled","disabled"),$("#r-panel td").attr("disabled","disabled")):($("#r-panel a").removeAttr("disabled"),$("#r-panel input").prop("disabled",!1),$("#r-panel textarea").prop("disabled",!1),$("#r-panel label").removeAttr("disabled"),$("#r-panel td").removeAttr("disabled"))},_openReport:function(n){var t=this,i=t._reportWindow(n.report,n.isOwner);i.title(n.report.name);i.maximize();i.open();var u=$.proxy(function(){t._reportSave(i,n.report)},t),f=$.proxy(function(n){t._exportReport(n)}),r=null;r=$.proxy(function(){t._reportWindowClose(i,n.report,u,f);i.unbind("close",r)},t);n.report.bind("busy",t._isBusyChanged);n.report.bind("save",u);n.report.bind("filter",t._reportFilter);n.report.bind("export",f);i.bind("close",r)},_collapsePanel:function(){var n=$("#r-report").data("kendoSplitter");n.collapse(".k-pane:first")},_reportFilter:function(n){var i={title:kendo.format("{0} Filter",n.viewModel.field.name),closable:!1,modal:!0,content:kendo.template($("#r-filter-prompt-template").html()),actions:[{text:"OK",primary:!0,action:function(){n.result.resolve()}},{text:"Cancel"}],close:function(){this.destroy()}},t=$("<div><\/div>").kendoDialog(i).data("kendoDialog");kendo.bind($(t.element),n.viewModel);t.open()},_reportSave:function(n,t){this.viewModel.updateTile(t);n.title(t.currentName)},_reportWindow:function(n,t){var i={width:"1024px",height:"720px",visible:!1,modal:!0,content:{template:kendo.template($("#r-template").html())},actions:["Maximize","Close"]},r={panes:[{collapsed:!t,collapsible:t,size:"325px",min:"325px"},{collapsible:!1}],orientation:"horizontal"},u=$("<div id='r-window'><\/div>"),f=u.kendoWindow(i).data("kendoWindow"),e=$("#r-report"),o=e.kendoSplitter(r).data("kendoSplitter");$("#r-panel-collapse").on("click",this._collapsePanel);return kendo.bind($("#r-report"),n),f},_reportWindowClose:function(n,t,i,r){$("#r-panel-collapse").off("click",this._collapsePanel);t.unbind("export",r);t.unbind("save",i);n.destroy()},_shareReport:function(n){var i={title:"Share Report",closable:!1,modal:!0,content:kendo.template($("#sr-window-template").html()),width:500,actions:[{text:"OK",primary:!0,action:function(){n.result.resolve()}},{text:"Cancel"}],close:function(){this.destroy()}},t=$("<div><\/div>").kendoDialog(i).data("kendoDialog");kendo.bind($(t.element),n.viewModel);t.open()},_toggleCard:function(n){var i=$(n.target).parents(".r-card")[0],t=$(i).find(".r-card-body")[0];$(t).is(":visible")?$(t).fadeOut(225):$(t).fadeIn(225)},_ui:function(){$("body").kendoTooltip({filter:"a[title]:not(a[title='']), span[title]:not(span[title=''])",position:"top"})}});